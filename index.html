<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sabre v4.2 (Botones Corregidos)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8"></script>
    <style>
        /* --- Estilos de la App Principal (sin cambios ) --- */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background-color: #121212; color: white; }
        #main-slider { width: 100%; height: 100vh; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch; }
        .page-container { width: 100%; height: 100vh; scroll-snap-align: start; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; text-align: center; }
        #neuronal-page h1 { margin-bottom: 10px; }
        #neuronal-log { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; width: 90%; max-width: 500px; height: 150px; overflow-y: auto; margin-bottom: 20px; text-align: left; }
        #neuronal-mic-btn { background-color: #007bff; color: white; border: none; border-radius: 50%; width: 80px; height: 80px; font-size: 36px; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: transform 0.2s, background-color 0.2s; }
        #neuronal-mic-btn.recording { background-color: #dc3545; transform: scale(1.1); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220,53,69,0.7); } 70% { box-shadow: 0 0 0 20px rgba(220,53,69,0); } 100% { box-shadow: 0 0 0 0 rgba(220,53,69,0); } }
        #cargo-page { justify-content: flex-start; padding-top: 60px; }
        #cargo-status { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: #007bff; padding: 5px 15px; border-radius: 15px; font-weight: bold; }
        #cargo-form { width: 100%; max-width: 400px; }
        .input-group { margin-bottom: 15px; position: relative; }
        .input-group input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #555; background: #333; color: white; font-size: 16px; box-sizing: border-box; }
        #nro_historia_group::before { content: 'E'; position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #aaa; pointer-events: none; }
        #nro_historia { padding-left: 28px !important; }
        #nfua::-webkit-outer-spin-button, #nfua::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #nfua { -moz-appearance: textfield; }
        .action-buttons { display: flex; flex-direction: column; gap: 12px; margin-top: 25px; width: 100%; }
        .btn { padding: 15px; border-radius: 8px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary { background-color: #28a745; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-info { background-color: #17a2b8; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; }
        .modal-content { background: #2a2a2a; padding: 20px; border-radius: 10px; width: 95%; max-width: 600px; display: flex; flex-direction: column; }
        #cargo-list-container { max-height: 70vh; overflow-y: auto; }
        .cargo-item-header { background: #333; padding: 15px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; font-weight: bold; }
        .cargo-item-content { display: none; padding: 10px; background: #1e1e1e; border-radius: 8px; margin-bottom: 10px; }
        .cargo-item-content table { width: 100%; color: white; border-collapse: collapse; font-size: 12px; }
        .cargo-item-content th, .cargo-item-content td { padding: 8px; text-align: left; border-bottom: 1px solid #444; }
        .cargo-item-content .record-actions { margin-top: 10px; display: flex; gap: 10px; }
        .btn-danger { background-color: #dc3545; color: white; }
    </style>
</head>
<body>

    <!-- HTML Principal (sin cambios) -->
    <div id="main-slider">
        <div id="neuronal-page" class="page-container">
            <h1>Modo Neuronal</h1>
            <p>Presiona el micrÃ³fono para grabar una nota.</p>
            <div id="neuronal-log"></div>
            <button id="neuronal-mic-btn">ðŸŽ¤</button>
        </div>
        <div id="cargo-page" class="page-container">
            <div id="cargo-status">Cargo Actual: -</div>
            <form id="cargo-form">
                <div class="input-group"><input type="number" id="nfua" placeholder="NÂ° FUA" required></div>
                <div class="input-group"><input type="text" id="nombre" placeholder="Nombre Completo" required></div>
                <div class="input-group" id="nro_historia_group"><input type="text" id="nro_historia" placeholder="NÂ° Historia" required inputmode="numeric"></div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">AÃ±adir Registro al Cargo</button>
                    <button type="button" id="generate-list-btn" class="btn btn-info">Generar Lista para Exportar</button>
                    <button type="button" id="manage-cargos-btn" class="btn btn-secondary">Ver/Gestionar Cargos</button>
                    <button type="button" id="force-new-cargo-btn" class="btn btn-warning">Forzar Nuevo Cargo</button>
                </div>
            </form>
        </div>
    </div>
    <div id="manage-cargos-modal" class="modal">
        <div class="modal-content">
            <h2>Gestor de Cargos</h2>
            <div id="cargo-list-container"></div>
            <button onclick="document.getElementById('manage-cargos-modal').style.display='none'" class="btn" style="margin-top: 20px; background: #555;">Cerrar</button>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://esiklpxyectbekxvajnw.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzaWtscHh5ZWN0YmVreHZham53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2OTI1MjEsImV4cCI6MjA3NzI2ODUyMX0.mtQnqUrTmhmN1DQxOAUnGpizhYZobStHDH0cz_XfKGU';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey );

        // ==================================================================
        // LÃ“GICA DE GENERAR LISTA (CORREGIDA)
        // ==================================================================
        const generateListBtn = document.getElementById('generate-list-btn');
        generateListBtn.addEventListener('click', async () => {
            if (!currentPosition) { alert('No hay un cargo activo.'); return; }
            const { data, error } = await supabase.from('cargo').select('*').eq('posicion', currentPosition).order('created_at', { ascending: true });
            if (error || !data || data.length === 0) {
                alert('No hay registros en el cargo actual para generar una lista.');
                return;
            }

            let tableRows = data.map(row => `<tr><td>${row.nfua||''}</td><td>${row.nombre||''}</td><td>${row.nro_historia||''}</td></tr>`).join('');

            let reportHTML = `
                <!DOCTYPE html><html lang="es"><head>
                    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Cargo NÂ° ${currentPosition}</title>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"><\/script>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"><\/script>
                    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"><\/script>
                    <style>
                        body { font-family: sans-serif; margin: 0; padding: 10px; background-color: #f0f0f0; }
                        #report-wrapper { max-width: 800px; margin: auto; }
                        #report-container { background-color: white; padding: 20px; border: 1px solid #ccc; }
                        table { width: 100%; border-collapse: collapse; } th, td { border: 1px solid #ccc; padding: 8px; }
                        .signatures-block { display: none; justify-content: space-around; margin-top: 20px; padding-top: 20px; border-top: 1px solid #ccc; }
                        .signature-box { text-align: center; } .signature-box img { width: 200px; height: 100px; border-bottom: 1px solid #555; }
                        .action-bar { text-align: center; margin-top: 20px; } .action-bar button { padding: 12px 18px; margin: 5px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; background-color: #007bff; color: white; }
                        #sign-btn { background-color: #ffc107; color: black; } #share-btn { background-color: #25D366; }
                        #signature-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9 ); z-index: 1000; }
                        #signature-slider { display: flex; width: 200%; height: 100%; transition: transform 0.3s ease-in-out; }
                        .signature-page { width: 50%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 10px; box-sizing: border-box; }
                        .signature-pad-container { width: 95%; max-width: 500px; height: 60%; background: #000050; border-radius: 10px; position: relative; }
                        .signature-pad-container canvas { width: 100%; height: 100%; border-radius: 10px; }
                        .signature-page h3 { color: white; }
                        .signature-page-nav { display: flex; justify-content: space-between; width: 95%; max-width: 500px; margin-top: 20px; }
                        .nav-btn { padding: 15px; border-radius: 8px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; }
                        .nav-btn-left { background-color: #dc3545; color: white; } .nav-btn-right { background-color: #007bff; color: white; } .nav-btn-final { background-color: #00c6ff; color: black; }
                    </style>
                </head><body>
                    <div id="report-wrapper">
                        <div id="report-container">
                            <h2>Cargo NÂ°: ${currentPosition}</h2>
                            <table><thead><tr><th>NÂ° FUA</th><th>Nombre Completo</th><th>NÂ° Historia</th></tr></thead><tbody>${tableRows}</tbody></table>
                            <div class="signatures-block" id="signatures-block">
                                <div class="signature-box"><img id="img-entrega" crossorigin="anonymous"><p>Firma Entrega</p></div>
                                <div class="signature-box"><img id="img-recepcion" crossorigin="anonymous"><p>Firma RecepciÃ³n</p></div>
                            </div>
                        </div>
                        <div class="action-bar">
                            <button id="sign-btn">Firmar Documento</button>
                            <button id="download-pdf">Descargar PDF</button>
                            <button id="download-jpg">Descargar JPG</button>
                            <button id="share-btn">Compartir</button>
                        </div>
                    </div>
                    <div id="signature-modal">
                        <div id="signature-slider">
                            <div class="signature-page">
                                <h3>Firma de quien Entrega</h3>
                                <div class="signature-pad-container"><canvas id="pad-entrega"></canvas></div>
                                <div class="signature-page-nav"><button class="nav-btn nav-btn-left" id="close-modal-btn">Volver</button><button class="nav-btn nav-btn-right" id="next-page-btn">Siguiente</button></div>
                            </div>
                            <div class="signature-page">
                                <h3>Firma de quien Recibe</h3>
                                <div class="signature-pad-container"><canvas id="pad-recepcion"></canvas></div>
                                <div class="signature-page-nav"><button class="nav-btn nav-btn-final" id="finish-sign-btn">Finalizar</button><button class="nav-btn nav-btn-left" id="prev-page-btn">Regresar</button></div>
                            </div>
                        </div>
                    </div>
                    <script>
                        const supabase_report = window.supabase.createClient('${supabaseUrl}', '${supabaseKey}');
                        const { jsPDF } = window.jspdf;
                        const reportElement = document.getElementById('report-container');
                        const signBtn = document.getElementById('sign-btn');
                        const signatureModal = document.getElementById('signature-modal');
                        const signatureSlider = document.getElementById('signature-slider');
                        const padEntrega = new SignaturePad(document.getElementById('pad-entrega'));
                        const padRecepcion = new SignaturePad(document.getElementById('pad-recepcion'));
                        const cargoId = '${currentPosition}'; // Â¡CORRECCIÃ“N CLAVE!

                        signBtn.addEventListener('click', () => signatureModal.style.display = 'flex');
                        document.getElementById('close-modal-btn').addEventListener('click', () => signatureModal.style.display = 'none');
                        document.getElementById('next-page-btn').addEventListener('click', () => signatureSlider.style.transform = 'translateX(-50%)');
                        document.getElementById('prev-page-btn').addEventListener('click', () => signatureSlider.style.transform = 'translateX(0%)');

                        function dataURLToBlob(dataURL) {
                            const parts = dataURL.split(';base64,'); const contentType = parts[0].split(':')[1]; const raw = window.atob(parts[1]); const rawLength = raw.length; const uInt8Array = new Uint8Array(rawLength);
                            for (let i = 0; i < rawLength; ++i) { uInt8Array[i] = raw.charCodeAt(i); } return new Blob([uInt8Array], { type: contentType });
                        }

                        document.getElementById('finish-sign-btn').addEventListener('click', async () => {
                            const firmaEntregaData = !padEntrega.isEmpty() ? padEntrega.toDataURL('image/png') : null;
                            const firmaRecepcionData = !padRecepcion.isEmpty() ? padRecepcion.toDataURL('image/png') : null;
                            
                            async function uploadSignature(data, bucketName, type) {
                                if (!data) return null;
                                const blob = dataURLToBlob(data);
                                const filePath = \`public/\${type}_\${cargoId}_\${Date.now()}.png\`;
                                const { error } = await supabase_report.storage.from(bucketName).upload(filePath, blob);
                                if (error) throw new Error(\`Error subiendo firma de \${type}: \${error.message}\`);
                                return supabase_report.storage.from(bucketName).getPublicUrl(filePath).data.publicUrl;
                            }

                            try {
                                const entregaUrl = await uploadSignature(firmaEntregaData, 'firmas_entrega', 'entrega');
                                const recepcionUrl = await uploadSignature(firmaRecepcionData, 'firmas_recepcion', 'recepcion');

                                const { error: upsertError } = await supabase_report.from('cargos_firmados').upsert({
                                    posicion_cargo: cargoId, firma_entrega_url: entregaUrl, firma_recepcion_url: recepcionUrl, updated_at: new Date()
                                }, { onConflict: 'posicion_cargo' });
                                if (upsertError) throw new Error(\`Error guardando firmas: \${upsertError.message}\`);
                                
                                alert('Firmas guardadas con Ã©xito.');
                                signatureModal.style.display = 'none';
                                await loadSignatures();
                            } catch (e) { alert(e.message); console.error(e); }
                        });

                        async function loadSignatures() {
                            const { data, error } = await supabase_report.from('cargos_firmados').select('*').eq('posicion_cargo', cargoId).single();
                            if (data && (data.firma_entrega_url || data.firma_recepcion_url)) {
                                document.getElementById('signatures-block').style.display = 'flex';
                                if(data.firma_entrega_url) document.getElementById('img-entrega').src = data.firma_entrega_url + '?t=' + new Date().getTime();
                                if(data.firma_recepcion_url) document.getElementById('img-recepcion').src = data.firma_recepcion_url + '?t=' + new Date().getTime();
                                signBtn.textContent = 'Editar Firmas';
                                return true;
                            }
                            return false;
                        }

                        async function generateExportableImage(callback) {
                            const hasSignatures = await loadSignatures();
                            setTimeout(() => { // PequeÃ±a espera para que las imÃ¡genes de las firmas carguen
                                html2canvas(reportElement, { scale: 2, useCORS: true, windowWidth: reportElement.scrollWidth, windowHeight: reportElement.scrollHeight }).then(callback);
                            }, 500);
                        }

                        document.getElementById('download-pdf').addEventListener('click', () => {
                            generateExportableImage(canvas => {
                                const imgData = canvas.toDataURL('image/png'); const pdf = new jsPDF('p', 'mm', 'a4');
                                const pdfWidth = pdf.internal.pageSize.getWidth(); const pdfHeight = pdf.internal.pageSize.getHeight();
                                const imgProps = pdf.getImageProperties(imgData); const imgRatio = imgProps.width / imgProps.height;
                                let imgHeight = pdfWidth / imgRatio; let heightLeft = imgHeight; let position = 0;
                                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, imgHeight); heightLeft -= pdfHeight;
                                while (heightLeft > 0) {
                                    position = heightLeft - imgHeight; pdf.addPage();
                                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight); heightLeft -= pdfHeight;
                                }
                                pdf.save('Cargo-' + cargoId + '.pdf');
                            });
                        });
                        
                        document.getElementById('download-jpg').addEventListener('click', () => {
                            generateExportableImage(canvas => {
                                const link = document.createElement('a'); link.href = canvas.toDataURL('image/jpeg', 0.9);
                                link.download = 'Cargo-' + cargoId + '.jpg'; link.click();
                            });
                        });

                        document.getElementById('share-btn').addEventListener('click', () => {
                            if (!navigator.share) { alert('FunciÃ³n de compartir no soportada.'); return; }
                            generateExportableImage(canvas => {
                                canvas.toBlob(async (blob) => {
                                    const file = new File([blob], 'Cargo-' + cargoId + '.jpg', { type: 'image/jpeg' });
                                    if (navigator.canShare({ files: [file] })) {
                                        await navigator.share({ files: [file], title: 'Reporte de Cargo', text: 'Cargo NÂ° ' + cargoId });
                                    } else { alert('No se puede compartir este archivo.'); }
                                }, 'image/jpeg', 0.9);
                            });
                        });
                        loadSignatures();
                    <\/script>
                </body></html>`;
            
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
        });

        // ==================================================================
        // CÃ“DIGO ORIGINAL DE LA APP (RESTAURADO Y FUNCIONAL)
        // ==================================================================
        const neuronalMicBtn = document.getElementById('neuronal-mic-btn');
        const neuronalLog = document.getElementById('neuronal-log');
        const NeuronalSpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let neuronalRecognition;
        let isNeuronalRecording = false;
        if (NeuronalSpeechRecognition) {
            neuronalRecognition = new NeuronalSpeechRecognition();
            neuronalRecognition.lang = 'es-ES';
            neuronalRecognition.continuous = false;
            neuronalRecognition.onstart = () => { isNeuronalRecording = true; neuronalMicBtn.classList.add('recording'); neuronalMicBtn.textContent = '...'; };
            neuronalRecognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript;
                neuronalLog.innerHTML += `<div>- ${transcript}</div>`;
                neuronalLog.scrollTop = neuronalLog.scrollHeight;
                const { error } = await supabase.from('neuronal').insert({ contenido: transcript });
                if (error) { neuronalLog.innerHTML += `<div style="color: #ffcdd2;">Error: ${error.message}</div>`; } 
                else { neuronalLog.innerHTML += `<div style="color: #a5d6a7;">Guardado âœ“</div>`; }
            };
            neuronalRecognition.onend = () => { isNeuronalRecording = false; neuronalMicBtn.classList.remove('recording'); neuronalMicBtn.textContent = 'ðŸŽ¤'; };
            neuronalRecognition.onerror = (event) => { console.error('Error en Neuronal:', event.error); neuronalLog.innerHTML += `<div style="color: #ffcdd2;">Error: ${event.error}</div>`; };
        }
        neuronalMicBtn.addEventListener('click', () => {
            if (!NeuronalSpeechRecognition) { alert("Tu navegador no soporta el reconocimiento de voz."); return; }
            if (isNeuronalRecording) { neuronalRecognition.stop(); } 
            else { try { neuronalRecognition.start(); } catch(e) { alert("No se pudo iniciar el micrÃ³fono. Puede que ya estÃ© en uso."); } }
        });
        const cargoForm = document.getElementById('cargo-form');
        const cargoStatus = document.getElementById('cargo-status');
        const manageCargosBtn = document.getElementById('manage-cargos-btn');
        const manageCargosModal = document.getElementById('manage-cargos-modal');
        const cargoListContainer = document.getElementById('cargo-list-container');
        const forceNewCargoBtn = document.getElementById('force-new-cargo-btn');
        function formatNfua(value) { return value.toString().padStart(7, '0'); }
        function formatNroHistoria(value) {
            let cleanValue = value.replace(/[^0-9]/g, '');
            if (cleanValue.length === 9) { return 'E' + cleanValue; }
            if (cleanValue.length > 2 && cleanValue.length <= 8) {
                const year = cleanValue.substring(0, 2);
                const correlativo = cleanValue.substring(2);
                const paddedCorrelativo = correlativo.padStart(7, '0');
                return `E${year}${paddedCorrelativo}`;
            }
            return 'E' + cleanValue;
        }
        cargoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const rawNfua = document.getElementById('nfua').value;
            const rawNroHistoria = document.getElementById('nro_historia').value;
            const formattedNfua = formatNfua(rawNfua);
            const formattedNroHistoria = formatNroHistoria(rawNroHistoria);
            const newRecord = { nfua: formattedNfua, nombre: document.getElementById('nombre').value, nro_historia: formattedNroHistoria, posicion: currentPosition };
            const { error } = await supabase.from('cargo').insert(newRecord);
            if (error) { alert(`Error al guardar: ${error.message}`); } 
            else { alert(`Registro aÃ±adido al cargo actual.\nFUA: ${formattedNfua}\nHistoria: ${formattedNroHistoria}`); cargoForm.reset(); }
        });
        async function getNextPosition() {
            const today = new Date();
            const dateString = `${today.getDate()}${(today.getMonth() + 1)}${today.getFullYear()}`;
            const { data, error } = await supabase.from('cargo').select('posicion').like('posicion', `${dateString}%`).order('posicion', { ascending: false }).limit(1);
            if (error) { console.error("Error al buscar Ãºltimo cargo:", error); return null; }
            if (data.length > 0) {
                const lastIndex = parseInt(data[0].posicion.slice(dateString.length));
                return `${dateString}${lastIndex + 1}`;
            }
            return `${dateString}1`;
        }
        async function initializeCargo() {
            const { data, error } = await supabase.from('cargo').select('posicion').order('created_at', { ascending: false }).limit(1);
            if (error) { alert("Error de conexiÃ³n al inicializar."); return; }
            if (data.length > 0) { currentPosition = data[0].posicion; } 
            else { currentPosition = await getNextPosition(); }
            updateStatus();
        }
        function updateStatus() { cargoStatus.textContent = `Cargo Actual: ${currentPosition}`; }
        forceNewCargoBtn.addEventListener('click', async () => {
            if (confirm('Â¿EstÃ¡s seguro de que quieres forzar la creaciÃ³n de un nuevo cargo?')) {
                currentPosition = await getNextPosition();
                updateStatus();
                alert(`Listo para registrar en el Nuevo Cargo NÂ°: ${currentPosition}`);
            }
        });
        manageCargosBtn.addEventListener('click', async () => {
            const { data, error } = await supabase.from('cargo').select('posicion').order('created_at', { ascending: false });
            if (error) { alert('Error al cargar la lista de cargos.'); return; }
            const uniquePositions = [...new Set(data.map(item => item.posicion))];
            cargoListContainer.innerHTML = uniquePositions.map(pos => `<div class="cargo-item"><div class="cargo-item-header" onclick="toggleCargoDetails('${pos}')">Cargo: ${pos}</div><div id="content-${pos}" class="cargo-item-content">Cargando...</div></div>`).join('');
            manageCargosModal.style.display = 'flex';
        });
        async function toggleCargoDetails(posicion) {
            const contentDiv = document.getElementById(`content-${posicion}`);
            if (contentDiv.style.display === 'block') { contentDiv.style.display = 'none'; return; }
            contentDiv.style.display = 'block';
            const { data, error } = await supabase.from('cargo').select('*').eq('posicion', posicion);
            if (error) { contentDiv.innerHTML = 'Error al cargar registros.'; return; }
            contentDiv.innerHTML = `<table>${data.map(row => `<tr><td><input type="checkbox" class="record-checkbox" value="${row.id}"></td><td>${row.nombre}</td><td>${row.nfua}</td></tr>`).join('')}</table><div class="record-actions"><button class="btn btn-danger" onclick="deleteSelected('${posicion}')">Eliminar Seleccionados</button><button class="btn btn-primary" onclick="switchToCargo('${posicion}')">AÃ±adir a este Cargo</button></div>`;
        }
        function switchToCargo(posicion) {
            currentPosition = posicion;
            updateStatus();
            manageCargosModal.style.display = 'none';
            alert(`Cambiado al Cargo NÂ°: ${posicion}.`);
        }
        async function deleteSelected(posicion) {
            const contentDiv = document.getElementById(`content-${posicion}`);
            const checkboxes = contentDiv.querySelectorAll('.record-checkbox:checked');
            if (checkboxes.length === 0) { alert('Por favor, selecciona al menos un registro para eliminar.'); return; }
            if (!confirm(`Â¿EstÃ¡s seguro de que quieres eliminar ${checkboxes.length} registro(
