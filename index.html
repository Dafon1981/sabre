<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sabre v4.0 (Firmas)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8"></script>
    <style>
        /* --- Estilos Generales y de la App Principal (sin cambios ) --- */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background-color: #121212; color: white; }
        #main-slider { width: 100%; height: 100vh; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch; }
        .page-container { width: 100%; height: 100vh; scroll-snap-align: start; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; text-align: center; }
        #neuronal-page h1 { margin-bottom: 10px; }
        #neuronal-log { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; width: 90%; max-width: 500px; height: 150px; overflow-y: auto; margin-bottom: 20px; text-align: left; }
        #neuronal-mic-btn { background-color: #007bff; color: white; border: none; border-radius: 50%; width: 80px; height: 80px; font-size: 36px; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: transform 0.2s, background-color 0.2s; }
        #neuronal-mic-btn.recording { background-color: #dc3545; transform: scale(1.1); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220,53,69,0.7); } 70% { box-shadow: 0 0 0 20px rgba(220,53,69,0); } 100% { box-shadow: 0 0 0 0 rgba(220,53,69,0); } }
        #cargo-page { justify-content: flex-start; padding-top: 60px; }
        #cargo-status { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: #007bff; padding: 5px 15px; border-radius: 15px; font-weight: bold; }
        #cargo-form { width: 100%; max-width: 400px; }
        .input-group { margin-bottom: 15px; position: relative; }
        .input-group input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #555; background: #333; color: white; font-size: 16px; box-sizing: border-box; }
        #nro_historia_group::before { content: 'E'; position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #aaa; pointer-events: none; }
        #nro_historia { padding-left: 28px !important; }
        #nfua::-webkit-outer-spin-button, #nfua::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #nfua { -moz-appearance: textfield; }
        .action-buttons { display: flex; flex-direction: column; gap: 12px; margin-top: 25px; width: 100%; }
        .btn { padding: 15px; border-radius: 8px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary { background-color: #28a745; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-info { background-color: #17a2b8; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
    </style>
</head>
<body>

    <!-- HTML Principal (sin cambios) -->
    <div id="main-slider">
        <div id="neuronal-page" class="page-container">...</div>
        <div id="cargo-page" class="page-container">
            <div id="cargo-status">Cargo Actual: -</div>
            <form id="cargo-form">
                <div class="input-group"><input type="number" id="nfua" placeholder="N° FUA" required></div>
                <div class="input-group"><input type="text" id="nombre" placeholder="Nombre Completo" required></div>
                <div class="input-group" id="nro_historia_group"><input type="text" id="nro_historia" placeholder="N° Historia" required inputmode="numeric"></div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">Añadir Registro al Cargo</button>
                    <button type="button" id="generate-list-btn" class="btn btn-info">Generar Lista para Exportar</button>
                    <button type="button" id="manage-cargos-btn" class="btn btn-secondary">Ver/Gestionar Cargos</button>
                    <button type="button" id="force-new-cargo-btn" class="btn btn-warning">Forzar Nuevo Cargo</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        const supabaseUrl = 'https://esiklpxyectbekxvajnw.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzaWtscHh5ZWN0YmVreHZham53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2OTI1MjEsImV4cCI6MjA3NzI2ODUyMX0.mtQnqUrTmhmN1DQxOAUnGpizhYZobStHDH0cz_XfKGU';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey );

        const generateListBtn = document.getElementById('generate-list-btn');
        let currentPosition = null;

        // ==================================================================
        // ¡NUEVA FUNCIÓN DE GENERAR LISTA CON FLUJO DE FIRMA!
        // ==================================================================
        generateListBtn.addEventListener('click', async () => {
            const { data, error } = await supabase.from('cargo').select('*').eq('posicion', currentPosition).order('created_at', { ascending: true });
            if (error || !data || data.length === 0) {
                alert('No hay registros en el cargo actual para generar una lista.');
                return;
            }

            let tableRows = data.map(row => `<tr><td>${row.nfua||''}</td><td>${row.nombre||''}</td><td>${row.nro_historia||''}</td></tr>`).join('');

            let reportHTML = `
                <!DOCTYPE html>
                <html lang="es">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Cargo N° ${currentPosition}</title>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"><\/script>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"><\/script>
                    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"><\/script>
                    <style>
                        body { font-family: sans-serif; margin: 0; padding: 10px; background-color: #f0f0f0; }
                        #report-wrapper { max-width: 800px; margin: auto; }
                        #report-container { background-color: white; padding: 20px; border: 1px solid #ccc; }
                        table { width: 100%; border-collapse: collapse; } th, td { border: 1px solid #ccc; padding: 8px; }
                        .signatures-block { display: none; justify-content: space-around; margin-top: 20px; padding-top: 20px; border-top: 1px solid #ccc; }
                        .signature-box { text-align: center; } .signature-box img { width: 200px; height: 100px; border-bottom: 1px solid #555; }
                        .action-bar { text-align: center; margin-top: 20px; } .action-bar button { padding: 12px 18px; margin: 5px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; background-color: #007bff; color: white; }
                        #sign-btn { background-color: #ffc107; color: black; }
                        #share-btn { background-color: #25D366; }
                        /* Estilos del Modal de Firma */
                        #signature-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9 ); z-index: 1000; }
                        #signature-slider { display: flex; width: 200%; height: 100%; transition: transform 0.3s ease-in-out; }
                        .signature-page { width: 50%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 10px; box-sizing: border-box; }
                        .signature-pad-container { width: 95%; height: 60%; background: #000050; border-radius: 10px; position: relative; }
                        .signature-pad-container canvas { width: 100%; height: 100%; }
                        .signature-page h3 { color: white; }
                        .signature-page-nav { display: flex; justify-content: space-between; width: 95%; margin-top: 20px; }
                        .nav-btn-left { background-color: #dc3545; } .nav-btn-right { background-color: #007bff; } .nav-btn-final { background-color: #00c6ff; }
                    </style>
                </head>
                <body>
                    <div id="report-wrapper">
                        <div id="report-container">
                            <h2>Cargo N°: ${currentPosition}</h2>
                            <table><thead><tr><th>N° FUA</th><th>Nombre Completo</th><th>N° Historia</th></tr></thead><tbody>${tableRows}</tbody></table>
                            <div class="signatures-block" id="signatures-block">
                                <div class="signature-box"><img id="img-entrega"><p>Firma Entrega</p></div>
                                <div class="signature-box"><img id="img-recepcion"><p>Firma Recepción</p></div>
                            </div>
                        </div>
                        <div class="action-bar">
                            <button id="sign-btn">Firmar Documento</button>
                            <button id="download-pdf">Descargar PDF</button>
                            <button id="download-jpg">Descargar JPG</button>
                            <button id="share-btn">Compartir</button>
                        </div>
                    </div>

                    <!-- Modal de Firma -->
                    <div id="signature-modal">
                        <div id="signature-slider">
                            <div class="signature-page">
                                <h3>Firma de quien Entrega</h3>
                                <div class="signature-pad-container"><canvas id="pad-entrega"></canvas></div>
                                <div class="signature-page-nav">
                                    <button class="btn nav-btn-left" id="close-modal-btn">Cerrar</button>
                                    <button class="btn nav-btn-right" id="next-page-btn">Siguiente</button>
                                </div>
                            </div>
                            <div class="signature-page">
                                <h3>Firma de quien Recibe</h3>
                                <div class="signature-pad-container"><canvas id="pad-recepcion"></canvas></div>
                                <div class="signature-page-nav">
                                    <button class="btn nav-btn-final" id="finish-sign-btn">Finalizar y Guardar</button>
                                    <button class="btn nav-btn-right" id="prev-page-btn" style="background-color: #dc3545;">Regresar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <script>
                        const { jsPDF } = window.jspdf;
                        const reportElement = document.getElementById('report-container');
                        const signBtn = document.getElementById('sign-btn');
                        const signatureModal = document.getElementById('signature-modal');
                        const signatureSlider = document.getElementById('signature-slider');
                        
                        const padEntrega = new SignaturePad(document.getElementById('pad-entrega'));
                        const padRecepcion = new SignaturePad(document.getElementById('pad-recepcion'));

                        // Lógica para mostrar/ocultar modal y slider
                        signBtn.addEventListener('click', () => signatureModal.style.display = 'flex');
                        document.getElementById('close-modal-btn').addEventListener('click', () => signatureModal.style.display = 'none');
                        document.getElementById('next-page-btn').addEventListener('click', () => signatureSlider.style.transform = 'translateX(-50%)');
                        document.getElementById('prev-page-btn').addEventListener('click', () => signatureSlider.style.transform = 'translateX(0%)');

                        // Función para convertir dataURL a Blob
                        function dataURLToBlob(dataURL) {
                            const parts = dataURL.split(';base64,');
                            const contentType = parts[0].split(':')[1];
                            const raw = window.atob(parts[1]);
                            const rawLength = raw.length;
                            const uInt8Array = new Uint8Array(rawLength);
                            for (let i = 0; i < rawLength; ++i) {
                                uInt8Array[i] = raw.charCodeAt(i);
                            }
                            return new Blob([uInt8Array], { type: contentType });
                        }

                        // Lógica para finalizar y guardar firmas
                        document.getElementById('finish-sign-btn').addEventListener('click', async () => {
                            const firmaEntregaData = !padEntrega.isEmpty() ? padEntrega.toDataURL('image/png') : null;
                            const firmaRecepcionData = !padRecepcion.isEmpty() ? padRecepcion.toDataURL('image/png') : null;

                            let entregaUrl = null, recepcionUrl = null;

                            if (firmaEntregaData) {
                                const blob = dataURLToBlob(firmaEntregaData);
                                const filePath = \`public/firma_entrega_${currentPosition}_\${Date.now()}.png\`;
                                const { data, error } = await supabase.storage.from('firmas_entrega').upload(filePath, blob);
                                if(error) { alert('Error subiendo firma de entrega'); console.error(error); return; }
                                entregaUrl = supabase.storage.from('firmas_entrega').getPublicUrl(filePath).data.publicUrl;
                            }
                            if (firmaRecepcionData) {
                                const blob = dataURLToBlob(firmaRecepcionData);
                                const filePath = \`public/firma_recepcion_${currentPosition}_\${Date.now()}.png\`;
                                const { data, error } = await supabase.storage.from('firmas_recepcion').upload(filePath, blob);
                                if(error) { alert('Error subiendo firma de recepción'); console.error(error); return; }
                                recepcionUrl = supabase.storage.from('firmas_recepcion').getPublicUrl(filePath).data.publicUrl;
                            }

                            const { error: upsertError } = await supabase.from('cargos_firmados').upsert({
                                posicion_cargo: '${currentPosition}',
                                firma_entrega_url: entregaUrl,
                                firma_recepcion_url: recepcionUrl,
                                updated_at: new Date()
                            }, { onConflict: 'posicion_cargo' });

                            if(upsertError) { alert('Error guardando las firmas en la base de datos.'); console.error(upsertError); return; }
                            
                            alert('Firmas guardadas con éxito.');
                            signatureModal.style.display = 'none';
                            signBtn.textContent = 'Editar Firmas';
                            await loadSignatures();
                        });

                        // Función para cargar firmas existentes
                        async function loadSignatures() {
                            const { data, error } = await supabase.from('cargos_firmados').select('*').eq('posicion_cargo', '${currentPosition}').single();
                            if (data) {
                                document.getElementById('signatures-block').style.display = 'flex';
                                if(data.firma_entrega_url) document.getElementById('img-entrega').src = data.firma_entrega_url;
                                if(data.firma_recepcion_url) document.getElementById('img-recepcion').src = data.firma_recepcion_url;
                                signBtn.textContent = 'Editar Firmas';
                            }
                        }

                        // Lógica de exportación y compartir
                        async function generateExportableImage(callback) {
                            await loadSignatures(); // Asegurarse de que las firmas estén visibles si existen
                            html2canvas(reportElement, { scale: 2, useCORS: true, allowTaint: true }).then(callback);
                        }

                        document.getElementById('download-pdf').addEventListener('click', () => {
                            generateExportableImage(canvas => {
                                const imgData = canvas.toDataURL('image/png');
                                const pdf = new jsPDF('p', 'mm', 'a4');
                                const pdfWidth = pdf.internal.pageSize.getWidth();
                                const pdfHeight = pdf.internal.pageSize.getHeight();
                                const imgProps = pdf.getImageProperties(imgData);
                                const imgRatio = imgProps.width / imgProps.height;
                                let imgHeight = pdfWidth / imgRatio;
                                let heightLeft = imgHeight;
                                let position = 0;
                                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                                heightLeft -= pdfHeight;
                                while (heightLeft > 0) {
                                    position = heightLeft - imgHeight;
                                    pdf.addPage();
                                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                                    heightLeft -= pdfHeight;
                                }
                                pdf.save('Cargo-${currentPosition}.pdf');
                            });
                        });
                        
                        document.getElementById('download-jpg').addEventListener('click', () => {
                            generateExportableImage(canvas => {
                                const link = document.createElement('a');
                                link.href = canvas.toDataURL('image/jpeg', 0.9);
                                link.download = 'Cargo-${currentPosition}.jpg';
                                link.click();
                            });
                        });

                        document.getElementById('share-btn').addEventListener('click', () => {
                            if (!navigator.share) { alert('Función de compartir no soportada.'); return; }
                            generateExportableImage(canvas => {
                                canvas.toBlob(async (blob) => {
                                    const file = new File([blob], 'Cargo-${currentPosition}.jpg', { type: 'image/jpeg' });
                                    if (navigator.canShare({ files: [file] })) {
                                        await navigator.share({ files: [file], title: 'Reporte de Cargo', text: 'Cargo N° ${currentPosition}' });
                                    } else {
                                        alert('No se puede compartir este archivo.');
                                    }
                                }, 'image/jpeg', 0.9);
                            });
                        });

                        // Cargar firmas al iniciar la página de reporte
                        loadSignatures();
                    <\/script>
                </body>
                </html>
            `;
            
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
        });

        // ... (Resto del código de la app principal sin cambios) ...
    </script>
</body>
</html>
