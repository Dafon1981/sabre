<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sabre v2</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background-color: #121212; color: white; }
        #main-slider { width: 100%; height: 100vh; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch; }
        .page-container { width: 100%; height: 100vh; scroll-snap-align: start; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; text-align: center; }
        
        /* --- Estilos de Neuronal (sin cambios funcionales ) --- */
        #neuronal-page h1 { margin-bottom: 10px; }
        #neuronal-log { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; width: 90%; max-width: 500px; height: 150px; overflow-y: auto; margin-bottom: 20px; text-align: left; }
        #neuronal-mic-btn { background-color: #007bff; border-radius: 50%; width: 80px; height: 80px; /* ... etc */ }
        
        /* --- Estilos de Cargo (춰Completamente Nuevos!) --- */
        #cargo-page { justify-content: flex-start; padding-top: 60px; }
        #cargo-status { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: #007bff; padding: 5px 15px; border-radius: 15px; font-weight: bold; }
        #cargo-form { width: 100%; max-width: 400px; }
        .input-group { margin-bottom: 15px; }
        .input-group input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #555; background: #333; color: white; font-size: 16px; box-sizing: border-box; }
        .action-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .btn { padding: 15px; border-radius: 8px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary { background-color: #28a745; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-info { background-color: #17a2b8; color: white; }

        /* --- Estilos del Modal de Gesti칩n --- */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; }
        .modal-content { background: #2a2a2a; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; }
        #cargo-list { max-height: 60vh; overflow-y: auto; }
        .cargo-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #444; }
        .cargo-item button { margin-left: 5px; font-size: 12px; padding: 5px 8px; }
        .btn-danger { background-color: #dc3545; color: white; }
    </style>
</head>
<body>

    <div id="main-slider">
        <!-- P치gina Neuronal (simplificada para el ejemplo) -->
        <div id="neuronal-page" class="page-container">
            <h1>Modo Neuronal</h1>
            <p>Graba notas de voz r치pidas.</p>
            <div id="neuronal-log"></div>
            <button id="neuronal-mic-btn">游꿗</button>
        </div>

        <!-- P치gina Cargo (춰La nueva estrella!) -->
        <div id="cargo-page" class="page-container">
            <div id="cargo-status">Cargo Actual: -</div>
            
            <form id="cargo-form">
                <div class="input-group">
                    <input type="text" id="nfua" placeholder="N춿 FUA" required>
                </div>
                <div class="input-group">
                    <input type="text" id="nombre" placeholder="Nombre Completo" required>
                </div>
                <div class="input-group">
                    <input type="text" id="nro_historia" placeholder="N춿 Historia" required>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">A침adir Registro al Cargo</button>
                    <button type="button" id="generate-list-btn" class="btn btn-info">Generar Lista para Imprimir</button>
                    <button type="button" id="manage-cargos-btn" class="btn btn-secondary">Ver/Gestionar Cargos</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Gestionar Cargos -->
    <div id="manage-cargos-modal" class="modal">
        <div class="modal-content">
            <h2>Gestor de Cargos</h2>
            <div id="cargo-list"></div>
            <button onclick="document.getElementById('manage-cargos-modal').style.display='none'" class="btn" style="margin-top: 20px; background: #555;">Cerrar</button>
        </div>
    </div>

    <script>
        // --- Configuraci칩n ---
        const supabaseUrl = 'https://esiklpxyectbekxvajnw.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzaWtscHh5ZWN0YmVreHZham53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2OTI1MjEsImV4cCI6MjA3NzI2ODUyMX0.mtQnqUrTmhmN1DQxOAUnGpizhYZobStHDH0cz_XfKGU';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey );

        // --- Elementos del DOM ---
        const cargoForm = document.getElementById('cargo-form');
        const cargoStatus = document.getElementById('cargo-status');
        const manageCargosBtn = document.getElementById('manage-cargos-btn');
        const manageCargosModal = document.getElementById('manage-cargos-modal');
        const cargoList = document.getElementById('cargo-list');
        const generateListBtn = document.getElementById('generate-list-btn');
        let currentPosition = null;

        // --- L칩gica Principal de Cargo ---
        async function initializeCargo() {
            const today = new Date();
            const dateString = `${today.getDate()}${(today.getMonth() + 1)}${today.getFullYear()}`;
            
            // Busca el 칰ltimo cargo del d칤a para determinar el siguiente 칤ndice
            const { data, error } = await supabase
                .from('cargo')
                .select('posicion')
                .like('posicion', `${dateString}%`)
                .order('posicion', { ascending: false })
                .limit(1);

            if (error) {
                console.error("Error al buscar 칰ltimo cargo:", error);
                alert("Error de conexi칩n. No se pudo inicializar el cargo.");
                return;
            }

            if (data.length > 0) {
                const lastPosition = data[0].posicion;
                const lastIndex = parseInt(lastPosition.slice(dateString.length));
                currentPosition = `${dateString}${lastIndex}`; // Continuar con el 칰ltimo cargo no cerrado
            } else {
                currentPosition = `${dateString}1`; // Es el primer cargo del d칤a
            }
            updateStatus();
        }

        function updateStatus() {
            cargoStatus.textContent = `Cargo Actual: ${currentPosition}`;
        }

        cargoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(cargoForm);
            const newRecord = {
                nfua: document.getElementById('nfua').value,
                nombre: document.getElementById('nombre').value,
                nro_historia: document.getElementById('nro_historia').value,
                posicion: currentPosition
            };

            const { error } = await supabase.from('cargo').insert(newRecord);

            if (error) {
                alert(`Error al guardar: ${error.message}`);
            } else {
                alert('Registro a침adido al cargo actual.');
                cargoForm.reset();
            }
        });

        generateListBtn.addEventListener('click', async () => {
            const { data, error } = await supabase.from('cargo').select('*').eq('posicion', currentPosition);
            if (error || !data || data.length === 0) {
                alert('No hay registros en este cargo para generar una lista.');
                return;
            }

            let tableHTML = `
                <style>
                    body { font-family: sans-serif; }
                    table { width: 100%; border-collapse: collapse; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background-color: #f2f2f2; }
                    @media print { body { -webkit-print-color-adjust: exact; } }
                </style>
                <h2>Cargo N춿: ${currentPosition} - Fecha: ${new Date().toLocaleDateString()}</h2>
                <table>
                    <thead><tr><th>N춿 FUA</th><th>Nombre Completo</th><th>N춿 Historia</th></tr></thead>
                    <tbody>
                        ${data.map(row => `<tr><td>${row.nfua}</td><td>${row.nombre}</td><td>${row.nro_historia}</td></tr>`).join('')}
                    </tbody>
                </table>
            `;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(tableHTML);
            printWindow.document.close();
            printWindow.focus();
            
            // Preguntar si se cierra el cargo
            setTimeout(() => {
                if (confirm('Lista generada. 쮻eseas cerrar y archivar este cargo? Al hacerlo, el pr칩ximo registro iniciar치 un nuevo cargo.')) {
                    const today = new Date();
                    const dateString = `${today.getDate()}${(today.getMonth() + 1)}${today.getFullYear()}`;
                    const lastIndex = parseInt(currentPosition.slice(dateString.length));
                    currentPosition = `${dateString}${lastIndex + 1}`;
                    updateStatus();
                    alert(`Cargo archivado. El pr칩ximo registro ser치 para el nuevo Cargo N춿: ${currentPosition}`);
                }
            }, 500);
        });

        manageCargosBtn.addEventListener('click', async () => {
            const { data, error } = await supabase.from('cargo').select('posicion').order('created_at', { ascending: false });
            if (error) { alert('Error al cargar la lista de cargos.'); return; }
            
            const uniquePositions = [...new Set(data.map(item => item.posicion))];
            cargoList.innerHTML = uniquePositions.map(pos => `
                <div class="cargo-item">
                    <span>Cargo: ${pos}</span>
                    <div>
                        <button class="btn btn-primary" onclick="switchToCargo('${pos}')">A침adir</button>
                        <button class="btn btn-danger" onclick="deleteCargo('${pos}')">Eliminar</button>
                    </div>
                </div>
            `).join('');
            manageCargosModal.style.display = 'flex';
        });

        function switchToCargo(posicion) {
            currentPosition = posicion;
            updateStatus();
            manageCargosModal.style.display = 'none';
            alert(`Cambiado al Cargo N춿: ${posicion}. Ahora puedes a침adir m치s registros.`);
        }

        async function deleteCargo(posicion) {
            if (!confirm(`쮼st치s seguro de que quieres eliminar TODOS los registros del Cargo N춿 ${posicion}? Esta acci칩n no se puede deshacer.`)) return;
            
            const { error } = await supabase.from('cargo').delete().eq('posicion', posicion);
            if (error) {
                alert(`Error al eliminar el cargo: ${error.message}`);
            } else {
                alert(`Cargo N춿 ${posicion} eliminado con 칠xito.`);
                manageCargosModal.style.display = 'none';
                if (currentPosition === posicion) {
                    initializeCargo(); // Si se borr칩 el cargo actual, inicializa uno nuevo
                }
            }
        }

        // Iniciar la aplicaci칩n
        window.onload = initializeCargo;

    </script>
</body>
</html>
